<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">

<head>
    
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
   <meta name="description" content="All Kind of Snippets!">
   <meta name="keywords" content="sunnyarora-tech, sunnyarora tech, sunny arora tech, snippets, code, programming, python, sunny arora">
   <meta name="author" content="Sunny Arora">

   <meta property="og:image" content="/static/img/snippets/avatar/avatar.png"/>
   <meta property="og:site_name" content="Useful Snippets"/>

   <link rel="shortcut icon" href="/static/img/favico.ico" type="image/x-icon">


   <title>Useful Snippets</title>
   <!-- =============== VENDOR STYLES ===============-->
   <!-- FONT AWESOME-->
   <link rel="stylesheet" href="/static/css/font-awesome.css">
   <!-- SIMPLE LINE ICONS-->
   <link rel="stylesheet" href="/static/css/simple-line-icons.css">
   <!-- FONT MFIZZ (programming languages icons)-->
   <link rel="stylesheet" href="/static/css/font-mfizz.css">
   <!-- ANIMATE.CSS-->
   <link rel="stylesheet" href="/static/css/animate.min.css">
   <!-- WHIRL (spinners)-->
   <link rel="stylesheet" href="/static/css/whirl.css">
   <!-- =============== PAGE VENDOR STYLES ===============-->
   <!-- =============== BOOTSTRAP STYLES ===============-->
   <link rel="stylesheet" href="/static/css/bootstrap.min.css" id="bscss">
   <!-- =============== APP STYLES ===============-->
   <link rel="stylesheet" href="/static/css/app.css" id="maincss">
   <!-- =============== SYNTAX HIGHLIGHTING ===============-->
   <link rel="stylesheet" href="/static/css/monokai.min.css">
</head>

<body>
   <div class="wrapper">
      <!-- top navbar-->
      <header class="topnavbar-wrapper">
         <!-- START Top Navbar-->
         <nav role="navigation" class="navbar topnavbar">
            <!-- START navbar header-->
            <div class="navbar-header">
               <a href="snippets" class="navbar-brand">
                  <div class="brand-logo">

                      <h4 style="color: white">Useful Articles</h4>
                  </div>
                  <div class="brand-logo-collapsed">

                      <h4 style="color: white">SA</h4>
                  </div>
               </a>
            </div>
            <!-- END navbar header-->
            <!-- START Nav wrapper-->
            <div class="nav-wrapper">
               <!-- START Left navbar-->
               <ul class="nav navbar-nav">
                  <li>
                     <!-- Button used to collapse the left sidebar. Only visible on tablet and desktops-->
                     <a href="#" data-toggle-state="aside-collapsed" class="hidden-xs">
                        <em class="fa fa-navicon"></em>
                     </a>
                     <!-- Button to show/hide the sidebar on mobile. Visible on mobile only.-->
                     <a href="#" data-toggle-state="aside-toggled" data-no-persist="true" class="visible-xs sidebar-toggle">
                        <em class="fa fa-navicon"></em>
                     </a>
                  </li>
               </ul>
               <!-- END Left navbar-->
            </div>
            <!-- END Nav wrapper-->
         </nav>
         <!-- END Top Navbar-->
      </header>
      <!-- sidebar-->
      <aside class="aside">
         <!-- START Sidebar (left)-->
         <div class="aside-inner">
            <nav data-sidebar-anyclick-close="" class="sidebar">
                <!-- START sidebar nav-->
                <ul class="nav">
                  <!-- Iterates over all sidebar items-->
                  <li class="nav-heading ">
                     <span data-localize="sidebar.heading.HEADER">Menu</span>
                  </li>
                  
                  <li class="active">
                     <a href="/snippets" title="Home">
                        <em class="icon-home" style="font-size: 25px;"></em>
                        <span data-localize="sidebar.nav.SINGLEVIEW">Home</span>
                     </a>
                  </li>
                  
                  <li class=" ">
                     <a href="#multilevel" title="Django" data-toggle="collapse">
                        <em class="icon-python" style="font-size: 25px;"></em>
                        <span>Django</span>
                     </a>
                     <ul id="multilevel" class="nav sidebar-subnav collapse">
                        <li class="sidebar-subnav-header">Django</li>

                        <!-- LEVEL 1 Django -->
                        <li class=" ">
                           <a href="/snippets/django/deployment" title="Deployment">
                              <span>Deployment</span>
                           </a>
                        </li>
                     </ul>
                  </li>
                   <li class=" ">
                     <a href="#multilevel-tool" title="Tools" data-toggle="collapse">
                        <em class="icon-python" style="font-size: 25px;"></em>
                        <span>Tools</span>
                     </a>
                     <ul id="multilevel-tool" class="nav sidebar-subnav collapse">
                        <li class="sidebar-subnav-header">Tools</li>

                        <!-- LEVEL 1 Tools -->
                        <li class=" ">
                           <a href="/snippets/tools/pycharm" title="PyCharm">
                              <span>PyCharm</span>
                           </a>
                        </li>
                        <li class=" ">
                           <a href="/snippets/tools/sublime" title="Sublime">
                              <span>Sublime</span>
                           </a>
                        </li>
                     </ul>
                  </li>
               </ul>
                <!-- END sidebar nav-->
            </nav>
         </div>
         <!-- END Sidebar (left)-->
      </aside>
      <!-- offsidebar-->
      <aside class="offsidebar hide">
         <!-- START Off Sidebar (right)-->
         <nav>
            <div role="tabpanel">
               <!-- Nav tabs-->
               <ul role="tablist" class="nav nav-tabs nav-justified">
                  <li role="presentation" class="active">
                     <a href="#app-settings" aria-controls="app-settings" role="tab" data-toggle="tab">
                        <em class="icon-equalizer fa-lg"></em>
                     </a>
                  </li>
                  <li role="presentation">
                     <a href="#app-chat" aria-controls="app-chat" role="tab" data-toggle="tab">
                        <em class="icon-user fa-lg"></em>
                     </a>
                  </li>
               </ul>
               <!-- Tab panes-->
               <div class="tab-content">
                  <div id="app-settings" role="tabpanel" class="tab-pane fade in active">
                     <h3 class="text-center text-thin">Tab 1</h3>
                  </div>
                  <div id="app-chat" role="tabpanel" class="tab-pane fade">
                     <h3 class="text-center text-thin">Tab 2</h3>
                  </div>
               </div>
            </div>
         </nav>
         <!-- END Off Sidebar (right)-->
      </aside>
      <!-- Main section-->
      <section>
         <!-- Page content-->
         <div class="content-wrapper">
             <div class="content-heading">
                  How To Set Up Django with Postgres, Nginx, and Gunicorn on Ubuntu 16.04
             </div>
             <div class="panel-anim-fadeIn">
                  <div class="content-body tutorial-content" data-growable-markdown>
					<h3 id="introduction">Introduction</h3>

						<p>In this guide, we will demonstrate how to install and configure some components on Ubuntu 16.04 to support and serve Django applications.  We will be setting up a PostgreSQL database instead of using the default SQLite database.  We will configure the Gunicorn application server to interface with our applications.  We will then set up Nginx to reverse proxy to Gunicorn, giving us access to its security and performance features to serve our apps.</p>

						<h2 id="prerequisites-and-goals">Prerequisites and Goals</h2>

						<p>We will be installing Django within a virtual environment.  Installing Django into an environment specific to your project will allow your projects and their requirements to be handled separately.</p>

						<p>Once we have our database and application up and running, we will install and configure the Gunicorn application server.  This will serve as an interface to our application, translating client requests in HTTP to Python calls that our application can process.  We will then set up Nginx in front of Gunicorn to take advantage of its high performance connection handling mechanisms and its easy-to-implement security features.</p>

						<p>Let's get started.</p>

						<h2 id="install-the-packages-from-the-ubuntu-repositories">Install the Packages from the Ubuntu Repositories</h2>

						<p>To begin the process, we'll download and install all of the items we need from the Ubuntu repositories.  We will use the Python package manager <code>pip</code> to install additional components a bit later.</p>

						<p>We need to update the local <code>apt</code> package index and then download and install the packages.  The packages we install depend on which version of Python your project will use.</p>

						<p>If you are using <strong>Python 2</strong>, type:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt-get update
						</li><li class="line" prefix="$">sudo apt-get install python-pip python-dev libpq-dev postgresql postgresql-contrib nginx
						</li></ul></code></pre>
						<p>If you are using Django with <strong>Python 3</strong>, type:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo apt-get update
						</li><li class="line" prefix="$">sudo apt-get install python3-pip python3-dev libpq-dev postgresql postgresql-contrib nginx
						</li></ul></code></pre>
						<p>This will install <code>pip</code>, the Python development files needed to build Gunicorn later, the Postgres database system and the libraries needed to interact with it, and the Nginx web server.</p>

						<h2 id="create-the-postgresql-database-and-user">Create the PostgreSQL Database and User</h2>

						<p>By default, Postgres uses an authentication scheme called "peer authentication" for local connections. Basically, this means that if the user's operating system username matches a valid Postgres username, that user can login with no further authentication.</p>

						<p>During the Postgres installation, an operating system user named <code>postgres</code> was created to correspond to the <code>postgres</code> PostgreSQL administrative user. We need to use this user to perform administrative tasks. We can use sudo and pass in the username with the -u option.</p>

						<p>Log into an interactive Postgres session by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo -u postgres psql
						</li></ul></code></pre>
						<p>You will be given a PostgreSQL prompt where we can set up our requirements.</p>

						<p>First, create a database for your project:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="postgres=#">CREATE DATABASE <span class="highlight">hello_django</span>;
						</li></ul></code></pre>
						<p><div class='code-label notes-and-warnings note' title='Note'>Note</div><span class='note'>
						Every Postgres statement must end with a semi-colon, so make sure that your command ends with one if you are experiencing issues.<br></span></p>

						<p>Next, create a database user for our project.  Make sure to select a secure password:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="postgres=#">CREATE USER <span class="highlight">hello_djangouser</span> WITH PASSWORD '<span class="highlight">password</span>';
						</li></ul></code></pre>
						<p>Afterwards, we'll modify a few of the connection parameters for the user we just created. This will speed up database operations so that the correct values do not have to be queried and set each time a connection is established.</p>

						<p>We are setting the default encoding to UTF-8, which Django expects. We are also setting the default transaction isolation scheme to "read committed", which blocks reads from uncommitted transactions. Lastly, we are setting the timezone. By default, our Django projects will be set to use <code>UTC</code>. These are all recommendations from <a href="https://docs.djangoproject.com/en/1.9/ref/databases/#optimizing-postgresql-s-configuration">the Django project itself</a>:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="postgres=#">ALTER ROLE <span class="highlight">hello_djangouser</span> SET client_encoding TO 'utf8';
						</li><li class="line" prefix="postgres=#">ALTER ROLE <span class="highlight">hello_djangouser</span> SET default_transaction_isolation TO 'read committed';
						</li><li class="line" prefix="postgres=#">ALTER ROLE <span class="highlight">hello_djangouser</span> SET timezone TO 'UTC';
						</li></ul></code></pre>
						<p>Now, we can give our new user access to administer our new database:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="postgres=#">GRANT ALL PRIVILEGES ON DATABASE <span class="highlight">hello_django</span> TO <span class="highlight">hello_djangouser</span>;
						</li></ul></code></pre>
						<p>When you are finished, exit out of the PostgreSQL prompt by typing:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="postgres=#">\q
						</li></ul></code></pre>
						<h2 id="create-a-python-virtual-environment-for-your-project">Create a Python Virtual Environment for your Project</h2>

						<p>Now that we have our database, we can begin getting the rest of our project requirements ready.  We will be installing our Python requirements within a virtual environment for easier management.</p>

						<p>To do this, we first need access to the <code>virtualenv</code> command.  We can install this with <code>pip</code>.</p>

						<p>If you are using <strong>Python 2</strong>, upgrade <code>pip</code> and install the package by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo -H pip install --upgrade pip
						</li><li class="line" prefix="$">sudo -H pip install virtualenv
						</li></ul></code></pre>
						<p>If you are using <strong>Python 3</strong>, upgrade <code>pip</code> and install the package by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo -H pip3 install --upgrade pip
						</li><li class="line" prefix="$">sudo -H pip3 install virtualenv
						</li></ul></code></pre>
						<p>With <code>virtualenv</code> installed, we can start forming our project.  Create and move into a directory where we can keep our project files:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">mkdir ~/<span class="highlight">hello_django</span>
						</li><li class="line" prefix="$">cd ~/<span class="highlight">hello_django</span>
						</li></ul></code></pre>
						<p>Within the project directory, create a Python virtual environment by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">virtualenv <span class="highlight">hello_djangoenv</span>
						</li></ul></code></pre>
						<p>This will create a directory called <code><span class="highlight">hello_djangoenv</span></code> within your <code><span class="highlight">hello_django</span></code> directory.  Inside, it will install a local version of Python and a local version of <code>pip</code>.  We can use this to install and configure an isolated Python environment for our project.</p>

						<p>Before we install our project's Python requirements, we need to activate the virtual environment.  You can do that by:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">source <span class="highlight">hello_djangoenv</span>/bin/activate
						</li></ul></code></pre>
						<p>Your prompt should change to indicate that you are now operating within a Python virtual environment.  It will look something like this: <code>(<span class="highlight">hello_djangoenv</span>)<span class="highlight">user</span>@<span class="highlight">host</span>:~/<span class="highlight">hello_django</span>$</code>.</p>

						<p>With your virtual environment active, install Django, Gunicorn, and the <code>psycopg2</code> PostgreSQL adaptor with the local instance of <code>pip</code>:</p>

						<p><div class='code-label notes-and-warnings note' title='Note'>Note</div><span class='note'>
						Regardless of which version of Python you are using, when the virtual environment is activated, you should use the <code>pip</code> command (not <code>pip3</code>).<br></span></p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">pip install django gunicorn psycopg2
						</li></ul></code></pre>
						<p>You should now have all of the software needed to start a Django project.</p>

						<h2 id="create-and-configure-a-new-django-project">Create and Configure a New Django Project</h2>

						<p>With our Python components installed, we can create the actual Django project files.</p>

						<h3 id="create-the-django-project">Create the Django Project</h3>

						<p>Since we already have a project directory, we will tell Django to install the files here.  It will create a second level directory with the actual code, which is normal, and place a management script in this directory.  The key to this is that we are defining the directory explicitly instead of allowing Django to make decisions relative to our current directory:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">django-admin.py startproject <span class="highlight">hello_django</span> ~/<span class="highlight">hello_django</span>
						</li></ul></code></pre>
						<p>At this point, your project directory (<code>~/<span class="highlight">hello_django</span></code> in our case) should have the following content:</p>

						<ul>
						<li><code>~/hello_django/manage.py</code>: A Django project management script.</li>
						<li><code>~/hello_django/hello_django/</code>: The Django project package.  This should contain the <code>__init__.py</code>, <code>settings.py</code>, <code>urls.py</code>, and <code>wsgi.py</code> files.</li>
						<li><code>~/hello_django/hello_djangoenv/</code>: The virtual environment directory we created earlier.</li>
						</ul>

						<h3 id="adjust-the-project-settings">Adjust the Project Settings</h3>

						<p>The first thing we should do with our newly created project files is adjust the settings.  Open the settings file in your text editor:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">nano ~/<span class="highlight">hello_django</span>/<span class="highlight">hello_django</span>/settings.py
						</li></ul></code></pre>
						<p>Start by locating the <code>ALLOWED_HOSTS</code> directive.  This defines a list of the server's addresses or domain names may be used to connect to the Django instance.  Any incoming requests with a <strong>Host</strong> header that is not in this list will raise an exception.  Django requires that you set this to prevent a certain class of security vulnerability.</p>

						<p>In the square brackets, list the IP addresses or domain names that are associated with your Django server.  Each item should be listed in quotations with entries separated by a comma.  If you wish requests for an entire domain and any subdomains, prepend a period to the beginning of the entry.  In the snippet below, there are a few commented out examples used to demonstrate:</p>
						<div class="code-label " title="~/hello_django/hello_django/settings.py">~/hello_django/hello_django/settings.py</div><pre class="code-pre "><code langs="">. . .
						# The simplest case: just add the domain name(s) and IP addresses of your Django server
						# ALLOWED_HOSTS = [ 'example.com', '203.0.113.5']
						# To respond to 'example.com' and any subdomains, start the domain with a dot
						# ALLOWED_HOSTS = ['.example.com', '203.0.113.5']
						ALLOWED_HOSTS = ['<span class="highlight">sunnyarora-tech.com</span>', '<span class="highlight">second_domain_or_IP</span>', <span class="highlight">. . .</span>]
						</code></pre>
						<p>Next, find the section that configures database access.  It will start with <code>DATABASES</code>.  The configuration in the file is for a SQLite database.  We already created a PostgreSQL database for our project, so we need to adjust the settings.</p>

						<p>Change the settings with your PostgreSQL database information.  We tell Django to use the <code>psycopg2</code> adaptor we installed with <code>pip</code>.  We need to give the database name, the database username, the database user's password, and then specify that the database is located on the local computer.  You can leave the <code>PORT</code> setting as an empty string:</p>
						<div class="code-label " title="~/hello_django/hello_django/settings.py">~/hello_django/hello_django/settings.py</div><pre class="code-pre "><code langs="">. . .

						DATABASES = {
							'default': {
								'ENGINE': 'django.db.backends.<span class="highlight">postgresql_psycopg2</span>',
								'NAME': '<span class="highlight">hello_django</span>',
								'USER': '<span class="highlight">hello_djangouser</span>',
								'PASSWORD': '<span class="highlight">password</span>',
								'HOST': 'localhost',
								'PORT': '',
							}
						}

						. . .
						</code></pre>
						<p>Next, move down to the bottom of the file and add a setting indicating where the static files should be placed.  This is necessary so that Nginx can handle requests for these items.  The following line tells Django to place them in a directory called <code>static</code> in the base project directory:</p>
						<div class="code-label " title="~/hello_django/hello_django/settings.py">~/hello_django/hello_django/settings.py</div><pre class="code-pre "><code langs="">. . .

						STATIC_URL = '/static/'
						<span class="highlight">STATIC_ROOT = os.path.join(BASE_DIR, 'static/')</span>
						</code></pre>
						<p>Save and close the file when you are finished.</p>

						<h3 id="complete-initial-project-setup">Complete Initial Project Setup</h3>

						<p>Now, we can migrate the initial database schema to our PostgreSQL database using the management script:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">~/<span class="highlight">hello_django</span>/manage.py makemigrations
						</li><li class="line" prefix="(hello_djangoenv) $">~/<span class="highlight">hello_django</span>/manage.py migrate
						</li></ul></code></pre>
						<p>Create an administrative user for the project by typing:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">~/<span class="highlight">hello_django</span>/manage.py createsuperuser
						</li></ul></code></pre>
						<p>You will have to select a username, provide an email address, and choose and confirm a password.</p>

						<p>We can collect all of the static content into the directory location we configured by typing:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">~/<span class="highlight">hello_django</span>/manage.py collectstatic
						</li></ul></code></pre>
						<p>You will have to confirm the operation.  The static files will then be placed in a directory called <code>static</code> within your project directory.</p>

						<p>If you followed the initial server setup guide, you should have a UFW firewall protecting your server.  In order to test the development server, we'll have to allow access to the port we'll be using.</p>

						<p>Create an exception for port 8000 by typing:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">sudo ufw allow 8000
						</li></ul></code></pre>
						<p>Finally, you can test our your project by starting up the Django development server with this command:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">~/<span class="highlight">hello_django</span>/manage.py runserver 0.0.0.0:8000
						</li></ul></code></pre>
						<p>In your web browser, visit your server's domain name or IP address followed by <code>:8000</code>:</p>
						<pre class="code-pre "><code langs="">http://<span class="highlight">0.0.0.0</span>:8000
						</code></pre>
						<p>You should see the default Django index page:</p>

						<p><img src="{% static 'img/django_index.png' %}" alt="Django index page"></p>

						<p>If you append <code>/admin</code> to the end of the URL in the address bar, you will be prompted for the administrative username and password you created with the <code>createsuperuser</code> command:</p>

						<p><img src="{% static 'img/admin_login.png' %}" alt="Django admin login"></p>

						<p>After authenticating, you can access the default Django admin interface:</p>

						<p><img src="{% static 'img/admin_interface.png' %}" alt="Django admin interface"></p>

						<p>When you are finished exploring, hit <strong>CTRL-C</strong> in the terminal window to shut down the development server.</p>

						<h3 id="testing-gunicorn-39-s-ability-to-serve-the-project">Testing Gunicorn's Ability to Serve the Project</h3>

						<p>The last thing we want to do before leaving our virtual environment is test Gunicorn to make sure that it can serve the application.  We can do this by entering our project directory and using <code>gunicorn</code> to load the project's WSGI module:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">cd ~/<span class="highlight">hello_django</span>
						</li><li class="line" prefix="(hello_djangoenv) $">gunicorn --bind 0.0.0.0:8000 <span class="highlight">hello_django</span>.wsgi:application
						</li></ul></code></pre>
						<p>This will start Gunicorn on the same interface that the Django development server was running on.  You can go back and test the app again.</p>

						<p><span class='note'><strong>Note:</strong> The admin interface will not have any of the styling applied since Gunicorn does not know about the static CSS content responsible for this.<br></span></p>

						<p>We passed Gunicorn a module by specifying the relative directory path to Django's <code>wsgi.py</code> file, which is the entry point to our application, using Python's module syntax.  Inside of this file, a function called <code>application</code> is defined, which is used to communicate with the application.</p>

						<p>When you are finished testing, hit <strong>CTRL-C</strong> in the terminal window to stop Gunicorn.</p>

						<p>We're now finished configuring our Django application.  We can back out of our virtual environment by typing:</p>
						<pre class="code-pre custom_prefix"><code langs=""><ul class="prefixed"><li class="line" prefix="(hello_djangoenv) $">deactivate
						</li></ul></code></pre>
						<p>The virtual environment indicator in your prompt will be removed.</p>

						<h2 id="create-a-gunicorn-systemd-service-file">Create a Gunicorn systemd Service File</h2>

						<p>We have tested that Gunicorn can interact with our Django application, but we should implement a more robust way of starting and stopping the application server. To accomplish this, we'll make a systemd service file.</p>

						<p>Create and open a systemd service file for Gunicorn with <code>sudo</code> privileges in your text editor:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/systemd/system/gunicorn.service
						</li></ul></code></pre>
						<p>Start with the <code>[Unit]</code> section, which is used to specify metadata and dependencies. We'll put a description of our service here and tell the init system to only start this after the networking target has been reached:</p>
						<div class="code-label " title="/etc/systemd/system/gunicorn.service">/etc/systemd/system/gunicorn.service</div><pre class="code-pre "><code langs="">[Unit]
						Description=gunicorn daemon
						After=network.target
						</code></pre>
						<p>Next, we'll open up the <code>[Service]</code> section. We'll specify the user and group that we want to process to run under. We will give our regular user account ownership of the process since it owns all of the relevant files. We'll give group ownership to the <code>www-data</code> group so that Nginx can communicate easily with Gunicorn.</p>

						<p>We'll then map out the working directory and specify the command to use to start the service. In this case, we'll have to specify the full path to the Gunicorn executable, which is installed within our virtual environment. We will bind it to a Unix socket within the project directory since Nginx is installed on the same computer. This is safer and faster than using a network port. We can also specify any optional Gunicorn tweaks here. For example, we specified 3 worker processes in this case:</p>
						<div class="code-label " title="/etc/systemd/system/gunicorn.service">/etc/systemd/system/gunicorn.service</div><pre class="code-pre "><code langs="">[Unit]
						Description=gunicorn daemon
						After=network.target

						[Service]
						User=<span class="highlight">sunny</span>
						Group=www-data
						WorkingDirectory=/home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>
						ExecStart=/home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>/<span class="highlight">hello_djangoenv</span>/bin/gunicorn --access-logfile - --workers 3 --bind unix:/home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>/<span class="highlight">hello_django</span>.sock hello_django.wsgi:application
						</code></pre>
						<p>Finally, we'll add an <code>[Install]</code> section. This will tell systemd what to link this service to if we enable it to start at boot. We want this service to start when the regular multi-user system is up and running:</p>
						<div class="code-label " title="/etc/systemd/system/gunicorn.service">/etc/systemd/system/gunicorn.service</div><pre class="code-pre "><code langs="">[Unit]
						Description=gunicorn daemon
						After=network.target

						[Service]
						User=<span class="highlight">sunny</span>
						Group=www-data
						WorkingDirectory=/home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>
						ExecStart=/home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>/<span class="highlight">hello_djangoenv</span>/bin/gunicorn --access-logfile - --workers 3 --bind unix:/home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>/<span class="highlight">hello_django</span>.sock hello_django.wsgi:application

						[Install]
						WantedBy=multi-user.target
						</code></pre>
						<p>With that, our systemd service file is complete. Save and close it now.</p>

						<p>We can now start the Gunicorn service we created and enable it so that it starts at boot:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start gunicorn
						</li><li class="line" prefix="$">sudo systemctl enable gunicorn
						</li></ul></code></pre>
						<p>We can confirm that the operation was successful by checking for the socket file.</p>

						<h2 id="check-for-the-gunicorn-socket-file">Check for the Gunicorn Socket File</h2>

						<p>Check the status of the process to find out whether it was able to start:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status gunicorn
						</li></ul></code></pre>
						<p>Next, check for the existence of the <code><span class="highlight">hello_django</span>.sock</code> file within your project directory:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">ls /home/<span class="highlight">sunny</span>/<span class="highlight">hello_django</span>
						</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>manage.py  hello_django  hello_djangoenv  <span class="highlight">hello_django.sock</span>  static
						</code></pre>
						<p>If the <code>systemctl status</code> command indicated that an error occurred or if you do not find the <code><span class="highlight">hello_django</span>.sock</code> file in the directory, it's an indication that Gunicorn was not able to start correctly.  Check the Gunicorn process logs by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo journalctl -u gunicorn
						</li></ul></code></pre>
						<p>Take a look at the messages in the logs to find out where Gunicorn ran into problems.  There are many reasons that you may have run into problems, but often, if Gunicorn was unable to create the socket file, it is for one of these reasons:</p>

						<ul>
						<li>The project files are owned by the <code>root</code> user instead of a <code>sudo</code> user</li>
						<li>The <code>WorkingDirectory</code> path within the <code>/etc/systemd/system/gunicorn.service</code> file does not point to the project directory</li>
						<li>The configuration options given to the <code>gunicorn</code> process in the <code>ExecStart</code> directive are not correct.  Check the following items:

						<ul>
						<li>The path to the <code>gunicorn</code> binary points to the actual location of the binary within the virtual environment</li>
						<li>The <code>--bind</code> directive defines a file to create within a directory that Gunicorn can access</li>
						<li>The <code><span class="highlight">hello_django</span>.wsgi:application</code> is an accurate path to the WSGI callable.  This means that when you're in the <code>WorkingDirectory</code>, you should be able to reach the callable named <code>application</code> by looking in the <code><span class="highlight">hello_django</span>.wsgi</code> module (which translates to a file called <code>./hello_django/wsgi.py</code>)</li>
						</ul></li>
						</ul>

						<p>If you make changes to the <code>/etc/systemd/system/gunicorn.service</code> file, reload the daemon to reread the service definition and restart the Gunicorn process by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl daemon-reload
						</li><li class="line" prefix="$">sudo systemctl restart gunicorn
						</li></ul></code></pre>
						<p>Make sure you troubleshoot any of the above issues before continuing.</p>

						<h2 id="configure-nginx-to-proxy-pass-to-gunicorn">Configure Nginx to Proxy Pass to Gunicorn</h2>

						<p>Now that Gunicorn is set up, we need to configure Nginx to pass traffic to the process.</p>

						<p>Start by creating and opening a new server block in Nginx's <code>sites-available</code> directory:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nano /etc/nginx/sites-available/<span class="highlight">hello_django</span>
						</li></ul></code></pre>
						<p>Inside, open up a new server block.  We will start by specifying that this block should listen on the normal port 80 and that it should respond to our server's domain name or IP address:</p>
						<div class="code-label " title="/etc/nginx/sites-available/hello_django">/etc/nginx/sites-available/hello_django</div><pre class="code-pre "><code langs="">server {
					listen    443 ssl http2;
					listen [::]:433 ssl http2;

					root /home/sunny/hello_django; # this is important
					index index.html index.htm;

					server_name sunnyarora-tech.com;
					# maybe you have an ssl
					include /etc/nginx/ssl/globalssl.conf;

					location /media/  {
						alias /home/sunny/hello_django/media/;
					}

					location /static/ {
					alias /home/sunny/hello_django/static/;
					}

					location / {
						proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
						proxy_set_header Host $http_host;
						proxy_redirect off;
						proxy_pass http://unix:/home/sunny/hello_django/hello_django.sock;
					}

					#location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
					#    expires 30d;
					#}

					#location /robots.txt {
					#    alias /home/sunny/hello_django/static/robots.txt;
					#}

					#location /favicon.ico {
					#    alias /home/sunny/hello_django/static/favicon.ico;
					#}

					# maybe gzip stuff here too
				}

				server {
						listen 80;
						server_name sunnyarora-tech.com;
						return 301 https://$server_name$request_uri;
				}
			}
						</code></pre>
						<p>The above is a snippet taken from the Nginx configuration for the logECG website. This might match your needs if you’re using SSL on your website, otherwise, you simply can comment out the last server block, then replace listen 443 ssl http2;in the first server blog, with listen 80;and you’re good to go.</p>
						<p>Save and close the file when you are finished.  Now, we can enable the file by linking it to the <code>sites-enabled</code> directory:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ln -s /etc/nginx/sites-available/<span class="highlight">hello_django</span> /etc/nginx/sites-enabled
						</li></ul></code></pre>
						<p>Test your Nginx configuration for syntax errors by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nginx -t
						</li></ul></code></pre>
						<p>If no errors are reported, go ahead and restart Nginx by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart nginx
						</li></ul></code></pre>
						<p>Finally, we need to open up our firewall to normal traffic on port 80.  Since we no longer need access to the development server, we can remove the rule to open port 8000 as well:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo ufw delete allow 8000
						</li><li class="line" prefix="$">sudo ufw allow 'Nginx Full'
						</li></ul></code></pre>
						<p>You should now be able to go to your server's domain or IP address to view your application.</p>

						<div class='code-label notes-and-warnings note' title='Note'>Note</div><span class='note'><p>

						After configuring Nginx, the next step should be securing traffic to the server using SSL/TLS.  This is important because without it, all information, including passwords are sent over the network in plain text.</p>
						</span>

						<h2 id="troubleshooting-nginx-and-gunicorn">Troubleshooting Nginx and Gunicorn</h2>

						<p>If this last step does not show your application, you will need to troubleshoot your installation.</p>

						<h3 id="nginx-is-showing-the-default-page-instead-of-the-django-application">Nginx Is Showing the Default Page Instead of the Django Application</h3>

						<p>If Nginx displays the default page instead of proxying to your application, it usually means that you need to adjust the <code>server_name</code> within the <code>/etc/nginx/sites-available/<span class="highlight">hello_django</span></code> file to point to your server's IP address or domain name.</p>

						<p>Nginx uses the <code>server_name</code> to determine which server block to use to respond to requests.  If you are seeing the default Nginx page, it is a sign that Nginx wasn't able to match the request to a sever block explicitly, so it's falling back on the default block defined in <code>/etc/nginx/sites-available/default</code>.</p>

						<p>The <code>server_name</code> in your project's server block must be more specific than the one in the default server block to be selected.</p>

						<h3 id="nginx-is-displaying-a-502-bad-gateway-error-instead-of-the-django-application">Nginx Is Displaying a 502 Bad Gateway Error Instead of the Django Application</h3>

						<p>A 502 error indicates that Nginx is unable to successfully proxy the request.  A wide range of configuration problems express themselves with a 502 error, so more information is required to troubleshoot properly.</p>

						<p>The primary place to look for more information is in Nginx's error logs.  Generally, this will tell you what conditions caused problems during the proxying event.  Follow the Nginx error logs by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo tail -F /var/log/nginx/error.log
						</li></ul></code></pre>
						<p>Now, make another request in your browser to generate a fresh error (try refreshing the page).  You should see a fresh error message written to the log.  If you look at the message, it should help you narrow down the problem.</p>

						<p>You might see some of the following message:</p>

						<p><strong>connect() to unix:/home/sunny/hello_django/hello_django.sock failed (2: No such file or directory)</strong></p>

						<p>This indicates that Nginx was unable to find the <code>hello_django.sock</code> file at the given location.  You should compare the <code>proxy_pass</code> location defined within <code>/etc/nginx/sites-available/hello_django</code> file to the actual location of the <code>hello_django.sock</code> file generated in your project directory.</p>

						<p>If you cannot find a <code>hello_django.sock</code> file within your project directory, it generally means that the <code>gunicorn</code> process was unable to create it.  Go back to the <a href="#check-for-the-gunicorn-socket-file">section on checking for the Gunicorn socket file</a> to step through the troubleshooting steps for Gunicorn.</p>

						<p><strong>connect() to unix:/home/sunny/hello_django/hello_django.sock failed (13: Permission denied)</strong></p>

						<p>This indicates that Nginx was unable to connect to the Gunicorn socket because of permissions problems.  Usually, this happens when the procedure is followed using the root user instead of a <code>sudo</code> user.  While the Gunicorn process is able to create the socket file, Nginx is unable to access it.</p>

						<p>This can happen if there are limited permissions at any point between the root directory (<code>/</code>) the <code>hello_django.sock</code> file.  We can see the permissions and ownership values of the socket file and each of its parent directories by passing the absolute path to our socket file to the <code>namei</code> command:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">namei -nom /home/sunny/hello_django/hello_django.sock
						</li></ul></code></pre><pre class="code-pre "><code langs=""><div class="secondary-code-label " title="Output">Output</div>f: /home/sunny/hello_django/hello_django.sock
						 drwxr-xr-x root  root     /
						 drwxr-xr-x root  root     home
						 drwxr-xr-x sunny sunny    sunny
						 drwxrwxr-x sunny sunny    hello_django
						 srwxrwxrwx sunny www-data hello_django.sock
						</code></pre>
						<p>The output displays the permissions of each of the directory components.  By looking at the permissions (first column), owner (second column) and group owner (third column), we can figure out what type of access is allowed to the socket file.</p>

						<p>In the above example, the socket file and each of the directories leading up to the socket file have world read and execute permissions (the permissions column for the directories end with <code>r-x</code> instead of <code>---</code>).  The Nginx process should be able to access the socket successfully.</p>

						<p>If any of the directories leading up to the socket do not have world read and execute permission, Nginx will not be able to access the socket without allowing world read and execute permissions or making sure group ownership is given to a group that Nginx is a part of.  For sensitive locations like the <code>/root</code> directory, both of the above options are dangerous.  It's better to move the project files outside of the directory, where you can safely control access without compromising security.</p>

						<h3 id="django-is-displaying-quot-could-not-connect-to-server-connection-refused-quot">Django Is Displaying: "could not connect to server: Connection refused"</h3>

						<p>One message that you may see from Django when attempting to access parts of the application in the web browser is:</p>
						<pre class="code-pre "><code langs="">OperationalError at /admin/login/
						could not connect to server: Connection refused
							Is the server running on host "localhost" (127.0.0.1) and accepting
							TCP/IP connections on port 5432?
						</code></pre>
						<p>This indicates that Django is unable to connect to the Postgres database.  Make sure that the Postgres instance is running by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl status postgresql
						</li></ul></code></pre>
						<p>If it is not, you can start it and enable it to start automatically at boot (if it is not already configured to do so) by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl start postgresql
						</li><li class="line" prefix="$">sudo systemctl enable postgresql
						</li></ul></code></pre>
						<p>If you are still having issues, make sure the database settings defined in the <code>~/hello_django/hello_django/settings.py</code> file are correct.</p>

						<h3 id="further-troubleshooting">Further Troubleshooting</h3>

						<p>For additional troubleshooting, the logs can help narrow down root causes.  Check each of them in turn and look for messages indicating problem areas.</p>

						<p>The following logs may be helpful:</p>

						<ul>
						<li>Check the Nginx process logs by typing: <code>sudo journalctl -u nginx</code></li>
						<li>Check the Nginx access logs by typing: <code>sudo less /var/log/nginx/access.log</code></li>
						<li>Check the Nginx error logs by typing: <code>sudo less /var/log/nginx/error.log</code></li>
						<li>Check the Gunicorn application logs by typing: <code>sudo journalctl -u gunicorn</code></li>
						</ul>

						<p>As you update your configuration or application, you will likely need to restart the processes to adjust to your changes.</p>

						<p>If you update your Django application, you can restart the Gunicorn process to pick up the changes by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl restart gunicorn
						</li></ul></code></pre>
						<p>If you change <code>gunicorn</code> systemd service file, reload the daemon and restart the process by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo systemctl daemon-reload
						</li><li class="line" prefix="$">sudo systemctl restart gunicorn
						</li></ul></code></pre>
						<p>If you change the Nginx server block configuration, test the configuration and then Nginx by typing:</p>
						<pre class="code-pre command"><code langs=""><ul class="prefixed"><li class="line" prefix="$">sudo nginx -t &amp;&amp; sudo systemctl restart nginx
						</li></ul></code></pre>
						<p>These commands are helpful for picking up changes as you adjust your configuration.</p>

						<h2 id="references">References</h2>

						<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-16-04">Deploy Django Using Nginx, Postgres and Gunicorn</a></p>
						<p><a href="https://blog.khophi.co/postgresql-django-nginx-gunicorn-virtualenvwrapper-16-04-lts-ubuntu-server/">PostgreSQL Django Nginx Gunicorn with VirtualenvWrapper on 16.04 LTS Ubuntu Server</a></p>

					</div>
				</div>
				<hr>
			</div>
         </div>
      </section>
      <!-- Page footer-->


   </div>
   <!-- =============== VENDOR SCRIPTS ===============-->
   <!-- MODERNIZR-->
   <script src="/static/js/modernizr.custom.js"></script>
   <!-- JQUERY-->
   <script src="/static/js/jquery-1.11.1.min.js"></script>
   <!-- BOOTSTRAP-->
   <script src="/static/js/bootstrap.min.js"></script>
   <!-- STORAGE API-->
   <script src="/static/js/jquery.storageapi.js"></script>
   <!-- JQUERY EASING-->
   <script src="/static/js/jquery.easing.js"></script>
   <!-- ANIMO-->
   <script src="/static/js/animo.js"></script>
   <!-- SYNTAX HIGHLIGHTING -->
   <script src="/static/js/highlight.min.js"></script>
   <script>hljs.initHighlightingOnLoad();</script>
   <script src="/static/js/app.js"></script>

</body>

</html>